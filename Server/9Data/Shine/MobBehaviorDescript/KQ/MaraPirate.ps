open [RegenZacco]
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea01" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea02" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea03" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea04" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea05" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea06" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea07" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea08" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea09" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea10" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea12" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea13" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea14" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea15" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea16" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea17" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea18" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea19" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea21" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea22" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea23" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea24" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea25" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea26" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea27" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea28" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea29" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea30" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea31" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea32" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea33" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea34" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea35" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea36" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea37" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea38" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea39" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea43" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea44" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea46" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea49" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea50" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea51" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea52" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea53" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea54" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea55" "Breeder" "EventManagerA".
close

open [FirstBoss]
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea47" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea47" "Breeder" "EventManager".

    var MobNum.

    MobNum = 0.
    while MobNum == 0
    open
        howmanymob MobNum "KQ_Mara".
        call "IsTimeUp".
    close

    MobNum = 2.
    while MobNum > 0
    open
        howmanymob MobNum "KQ_Mara".
        call "IsTimeUp".
    close
close

open [SecondBoss]
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea48" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea48" "Breeder" "EventManager".

    var MobNum.

    MobNum = 0.
    while MobNum == 0
    open
        howmanymob MobNum "KQ_Marlone".
        call "IsTimeUp".
    close

    MobNum = 2.
    while MobNum > 0
    open
        howmanymob MobNum "KQ_Marlone".
        call "IsTimeUp".
    close
close

open [LastBoss]
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea40" "Breeder" "EventManagerA".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea45" "Breeder" "EventManagerA".

    var MobNum.

    MobNum = 0.
    while MobNum == 0
    open
        var Mara.
        var Marlone.
        howmanymob Mara    "KQ_TrueMara".
        howmanymob Marlone "KQ_TrueMarlone".
        MobNum = Mara + Marlone.
        call "IsTimeUp".
    close

    MobNum = 2.
    while MobNum > 0
    open
        var Mara.
        var Marlone.
        howmanymob Mara    "KQ_TrueMara".
        howmanymob Marlone "KQ_TrueMarlone".
        MobNum = Mara + Marlone.
        call "IsTimeUp".
    close
close
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
open [main]
    var MyName.
    var MyHandle.
    myname MyName.
    myhandle MyHandle.

    call MyName "DefRoutine".
close

open [DefRoutine]
close

open [WaitPlayerEntry]
    var InitRest.
    var CurRest.
    kqrestminute InitRest.                ; 남은 시간을 분단위로 얻어옴

    var Ply.
    Ply = 0.
    while Ply == 0
    open
        howmanymob Ply "Player".           ; 들어온 플레이어들 확인

        kqrestminute CurRest.                ; 남은 시간을 분단위로 얻어옴
        if InitRest - CurRest > 5               ; 5분간 대기
        then
        open
            print "Room vanish".
            endofevent KingdomQuest 0.       ; 킹덤퀘스트 실패로 마무리
            break "main".
        close
    close
close

open [IsTimeUp]            ; 시간제한이 다 되었는지 확인
    print "IsTimeUp".
    var TimeUp.
    kqrestminute TimeUp.                ; 남은 시간을 분단위로 얻어옴
    print "EventManagerAIsTimeUp : " % TimeUp % "Minute left".
    if TimeUp == 0                      ; 시간오버
    then
    open
        print "IsTimeUp : Exit 0".
        KQResult = "Fail".
        break "MainLoop".
    close

    var Ply.
    howmanymob Ply "Player".           ; 남아있는 플레이어들 확인
    print "EventManagerAIsTimeUp : " % Ply % "Player left".
    if Ply == 0
    then
    open
        print "IsTimeUp : Exit 1".
        KQResult = "Fail".
        break "MainLoop".
    close
close
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
open [EventManagerA]

    print "EventManagerA : Entry".

    call "WaitPlayerEntry".             ; 사람들이 들어올 때까지 기다림

    var KQResult.   ; IsTimeUp에서 사용할 변수

    open [MainLoop]
        call "RegenZacco".
        call "FirstBoss".
        call "SecondBoss".
        call "LastBoss".
        KQResult = "Success". ; 보스가 모두 전멸했으니 성공
    close

    wait sec 3.
    if KQResult === "Success"   ; 성공
    then
    open
        reward KingdomQuest.         ; 리워드를 줌
        broadcast all "마라의 해적 소탕에 성공하였습니다.".
        endofevent KingdomQuest 1.  ; 킹덤퀘스트 성공으로 마무리
    close
    else
    open
        broadcast all "마라의 해적 소탕에 실패하였습니다.".
        endofevent KingdomQuest 0.       ; 킹덤퀘스트 실패로 마무리
    close


    broadcast all "30초후 루멘으로 이동합니다.".
    wait sec 10.
    broadcast all "20초후 루멘으로 이동합니다.".
    wait sec 10.
    broadcast all "10초후 루멘으로 이동합니다.".
    wait sec 5.
    broadcast all "5초후 루멘으로 이동합니다.".
    wait sec 5.
    linkto all "Rou" "Rou" 7907 8572.

    mapclear all.

close

open [KQ_Mara]
    if Breeder === "EventManagerA"          ; 이벤트매니저에 의해 만들어진 마라일 경우
    then
    open
        var Target.
        Target = "".
        while Target === ""
        open
            whoistarget Target.     ; 타겟이 설정되었을 경우 타겟의 핸들 저장
        close

        ; 타겟발견
        shout all "" "그 누구도 이곳을 지나갈 수 없다!!!".
    close

    var CurHP.
    CurHP = 100.
    while CurHP > 0         ; 죽을 때까지 기다림
    open
        currenthp CurHP.
    close

    shout all "" "으윽, 부.. 분하다!".
close

open [KQ_Marlone]
    if Breeder === "EventManagerA"          ; 이벤트매니저에 의해 만들어진 마라일 경우
    then
    open
        wait sec 2.
        shout all "" "마라 방어선이 무너졌다. 모두 적들을 맞을 준비를 하라".
    close

    var CurHP.
    CurHP = 100.
    while CurHP > 0         ; 죽을 때까지 기다림
    open
        currenthp CurHP.
    close

    shout all "" "으악, 적들이 너무 많습니다!".
close

open [KQ_TrueMara]
    shout all "" "무능한 것들 같으니라구.".
    wait sec 4.
    shout all "" "흥, 혼자만 재미보게 할 수는 없지.".


    mobregen Aggressive "KDPrtShip" "KDPrtShipArea41" "Breeder" "KQ_TrueMara".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea41" "Breeder" "KQ_TrueMara".

    infinite
    open
        var MobNum.
        howmanymob MobNum "KQ_Mara".
        wait sec 60.
        mobregen Aggressive "KDPrtShip" "KDPrtShipArea41" "Breeder" "EventManagerA".
    close
close

open [KQ_TrueMarlone]
    wait sec 2.
    shout all "" "걱정마라, 마라, 이 말론이 모두 없애주마.".

    mobregen Aggressive "KDPrtShip" "KDPrtShipArea42" "Breeder" "KQ_TrueMarlone".
    mobregen Aggressive "KDPrtShip" "KDPrtShipArea42" "Breeder" "KQ_TrueMarlone".

    infinite
    open
        var MobNum.
        howmanymob MobNum "KQ_Marlone".
        wait sec 60.
        mobregen Aggressive "KDPrtShip" "KDPrtShipArea42" "Breeder" "EventManagerA".
    close
close
