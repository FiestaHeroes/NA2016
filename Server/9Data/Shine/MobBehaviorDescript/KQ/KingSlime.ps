open [Regen1stLayer]
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea05" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea07" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea55" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea06" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea11" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea14" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea13" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea12" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea16" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea09" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea10" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea08" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea24" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea15" "Breeder" "EventManagerA".

    call "WaitMobRegen".
    call "WaitMobAnnihilation".
close

open [Regen2ndLayer]
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea17" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea49" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea50" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea48" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea28" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea53" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea18" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea19" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea51" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea52" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea20" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea21" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea56" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea57" "Breeder" "EventManagerA".

    call "WaitMobRegen".
    call "WaitMobAnnihilation".
close

open [Regen3rdLayer]
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea26" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea22" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea27" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea25" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea23" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea30" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea29" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea03" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea04" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea45" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea46" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea47" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea44" "Breeder" "EventManagerA".

    call "WaitMobRegen".
    call "WaitMobAnnihilation".
close

open [RegenTopLayer]
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea41" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea40" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea39" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea42" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea43" "Breeder" "EventManagerA".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea54" "Breeder" "EventManagerA".

    call "WaitMobRegen".
    call "WaitMobAnnihilation".
close

open [KingSlimeSummon]
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea02" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea31" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea32" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea33" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea34" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea35" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea38" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea36" "Breeder" "KingSlime".
    mobregen Aggressive "KDEddyHill" "KDEddyHillArea37" "Breeder" "KingSlime".

    call "WaitMobRegen".
close
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
open [WaitPlayerEntry]
    var InitRest.
    var CurRest.
    kqrestminute InitRest.                ; 남은 시간을 분단위로 얻어옴

    var Ply.
    Ply = 0.
    while Ply == 0
    open
        howmanymob Ply "Player".           ; 들어온 플레이어들 확인

        kqrestminute CurRest.                ; 남은 시간을 분단위로 얻어옴
        if InitRest - CurRest > 5               ; 5분간 대기
        then
        open
            print "Room vanish".
            endofevent KingdomQuest 0.       ; 킹덤퀘스트 실패로 마무리
            break "main".
        close
    close
close

open [WaitMobRegen]
    var Mob.
    Mob = 0.
    while Mob == 0
    open
        howmanymob Mob "All".                ; 모든 몹수 확인
    close
close

open [WaitMobAnnihilation]
    var Mob.
    Mob = 10.
    while Mob > 0
    open
        howmanymob Mob "All".                ; 모든 몹수 확인
        call "IsTimeUp".
    close
close

open [WaitKingSlimeKill]
    var Mob.
    Mob = 10.
    while Mob > 0
    open
        howmanymob Mob "KQ_KingSlime".                ; 킹슬라임 갯수 확인
        call "IsTimeUp".
    close
close

open [IsTimeUp]            ; 시간제한이 다 되었는지 확인
    print "IsTimeUp".
    var TimeUp.
    kqrestminute TimeUp.                ; 남은 시간을 분단위로 얻어옴
    print "EventManagerAIsTimeUp : " % TimeUp % "Minute left".
    if TimeUp == 0                      ; 시간오버
    then
    open
        print "IsTimeUp : Exit 0".
        KQResult = "Fail".
        break "MainLoop".
    close

    var Ply.
    howmanymob Ply "Player".           ; 남아있는 플레이어들 확인
    print "EventManagerAIsTimeUp : " % Ply % "Player left".
    if Ply == 0
    then
    open
        print "IsTimeUp : Exit 1".
        KQResult = "Fail".
        break "MainLoop".
    close
close
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
open [main]
    var MyName.
    var MyHandle.
    myname MyName.          ; 내 이름을 얻는다(몹인덱스)
    myhandle MyHandle.

    call MyName "DefRoutine".   ; 인덱스와 동일한 루틴 호출
close

open [DefRoutine]
close
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
open [EventManagerA]

    print "EventManagerA : Entry".

    call "WaitPlayerEntry".             ; 사람들이 들어올 때까지 기다림

    var KQResult.   ; IsTimeUp에서 사용할 변수

    open [MainLoop]
        call "Regen1stLayer".
        call "Regen2ndLayer".
        call "Regen3rdLayer".
        call "RegenTopLayer".

        mobregen Aggressive "KDEddyHill" "KDEddyHillArea01" "Breeder" "KingSlime". ; 킹슬라임 리젠

        call "WaitMobRegen".
        call "WaitKingSlimeKill".

        KQResult = "Success".
    close

    wait sec 3.
    if KQResult === "Success"   ; 성공
    then
    open
        reward KingdomQuest.         ; 리워드를 줌
        broadcast all "슬라임들을 성공적으로 방어했습니다.".
        endofevent KingdomQuest 1.  ; 킹덤퀘스트 성공으로 마무리
    close
    else
    open
        broadcast all "슬라임들 방어에 실패했습니다.".
        endofevent KingdomQuest 0.       ; 킹덤퀘스트 실패로 마무리
    close

    broadcast all "30초후 루멘으로 이동합니다.".
    wait sec 10.
    broadcast all "20초후 루멘으로 이동합니다.".
    wait sec 10.
    broadcast all "10초후 루멘으로 이동합니다.".
    wait sec 5.
    broadcast all "5초후 루멘으로 이동합니다.".
    wait sec 5.
    linkto all "Rou" "Rou" 7907 8572.

    mapclear all.

close
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
open [KQ_KingSlime]
    var SummonHPRate.
    var MaxHP.
    currenthp MaxHP.
    SummonHPRate = 1000.

    shout all "" "성스러운 슬라임들을 모욕하는 더러운 생명체들이여".
    wait sec 2.
    shout all "" "너희들에게 영원한 저주를 내리노라!!!".

    while SummonHPRate > 0
    open
        var CurHP.
        var CurHPRate.

        currenthp CurHP.
        CurHPRate = (CurHP * 1000) / MaxHP.   ; 주의 : 이런 수식은 뒤에서부터 실행됨!!!!

        print "MaxHP[" % MaxHP % "]  CurHP[" % CurHP % "]   CurHPRate[" % CurHPRate % "]   SummonHPRate[" % SummonHPRate % "]".

        if CurHPRate < SummonHPRate
        then
        open
            shout all "" "슬라임들이여, 내 힘을 받아 저들을 멸하여라!!".
            call "KingSlimeSummon".
            SummonHPRate = SummonHPRate - 200.
        close
    close

    ; 킹슬라임이 죽었음
    var Mobs.
    howmanymob Mobs "all".
    if Mobs < 15
    then
    open
        shout all "" "아아, 정녕 슬라임의 시대는 갔단 말인가...".
    close
    else
    open
        shout all "" "남아있는 슬라임들이여, 명예를 위해 최선을 다하라".
    close
close
